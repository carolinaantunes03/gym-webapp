{% extends 'base.html' %}
{% load static %}

{% block title %}Pagamentos{% endblock %}

{% block content %}
<style>
body {
    background-color: #f5f5f5;
    color: #333;
}

.container {
    max-width: 900px;
    margin: 40px auto;
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

h2, h3 {
    color: #333;
    text-align: center;
    font-weight: bold;
}

.section {
    margin-top: 30px;
}

.card {
    background: #ff7f50;
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin: 15px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.card.future {
    background: #6fa8dc;
}

.card.history {
    background: #f7c26d;
    color: #fff;
}

.card.late {
    background: #dc3545;
    color: #fff;
}

button, .btn {
    background-color: #ff7f50;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    font-weight: bold;
    transition: background-color 0.3s, transform 0.2s;
}

button:hover, .btn:hover {
    background-color: #f7c26d;
    transform: translateY(-2px);
}

.cancel-btn {
    background-color: #dc3545;
}

.cancel-btn:hover {
    background-color: #c82333;
}

.reactivate-btn {
    background-color: #28a745;
}

.reactivate-btn:hover {
    background-color: #218838;
}

.btn-back {
    display: inline-block;
    background-color: #6c757d;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    text-decoration: none;
    margin-top: 30px;
}

.btn-back:hover {
    background-color: #5a6268;
}
</style>

<div class="container">
    <h2>Gest√£o de Pagamentos</h2>

    <div class="section text-center">
        <p><strong>Tipo de Subscri√ß√£o:</strong> {{ request.user.get_tipo_subscricao_display|default:"(sem subscri√ß√£o)" }}</p>
        <p><strong>Mensalidade:</strong> {{ valor_mensalidade|floatformat:2 }} ‚Ç¨</p>

        {% if cancel_effective_from %}
            <p><strong>Cancelamento agendado para:</strong> {{ cancel_effective_from|date:"d/m/Y" }}</p>
        {% endif %}
    </div>

    <hr>

    <!-- ATRASOS -->
    <div class="section">
        <h3>Pagamentos em atraso</h3>

        {% if pagamentos_em_atraso %}
            <p class="text-center"><em>‚ö† Pagamentos por pagar de meses anteriores (inclui multa de 5‚Ç¨).</em></p>

            {% for p in pagamentos_em_atraso %}
                <div class="card late">
                    <strong>M√™s:</strong> {{ p.mes_label|default:p.mes_referencia }}<br>
                    <strong>Data limite:</strong> {{ p.data_limite|date:"d/m/Y" }}<br>
                    <strong>Status:</strong> {{ p.get_status_display }}<br>
                    <strong>Valor a pagar:</strong> {{ p.valor|floatformat:2 }} ‚Ç¨<br>

                    <form action="{% url 'pagar' p.id %}" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="mt-2">Pagar agora üí∞</button>
                    </form>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-center">Sem pagamentos em atraso.</p>
        {% endif %}
    </div>

    <hr>

    <!-- PAGAMENTO ATUAL -->
    <div class="section">
        <h3>Pagamento Atual</h3>

        {% if pagamento_atual %}
            <div class="card">
                <strong>M√™s:</strong> {{ pagamento_atual.mes_label|default:pagamento_atual.mes_referencia }}<br>
                <strong>Data limite:</strong> {{ pagamento_atual.data_limite|date:"d/m/Y" }}<br>
                <strong>Status:</strong> {{ pagamento_atual.get_status_display }}<br>
                <strong>Valor:</strong> {{ pagamento_atual.valor|floatformat:2 }} ‚Ç¨<br>

                {% if pagamento_atual.em_atraso %}
                    <div class="mt-2"><em>‚ö† Em atraso (multa aplicada se aplic√°vel).</em></div>
                {% endif %}

                {% if pagamento_atual.status == 'por_pagar' %}
                    <form action="{% url 'pagar' pagamento_atual.id %}" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="mt-2">Pagar Agora üí∞</button>
                    </form>
                {% else %}
                    <div class="mt-2">‚úÖ Pago</div>
                {% endif %}
            </div>
        {% else %}
            <p class="text-center">N√£o h√° pagamento atual (subscri√ß√£o inativa).</p>
        {% endif %}
    </div>

    <!-- FUTUROS -->
    <div class="section">
        <h3>Pagamentos Futuros</h3>

        {% if futuros %}
            {% for f in futuros %}
                <div class="card future">
                    <strong>M√™s:</strong> {{ f.mes_label }}<br>
                    <strong>Data limite:</strong> {{ f.data_limite|date:"d/m/Y" }}<br>
                    <strong>Valor previsto:</strong> {{ f.valor|floatformat:2 }} ‚Ç¨<br>
                    <em>(Ainda n√£o registado)</em>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-center">Sem pagamentos futuros a mostrar.</p>
        {% endif %}
    </div>

    <!-- HIST√ìRICO -->
    <div class="section">
        <h3>Hist√≥rico</h3>
        <p class="text-center"><strong>Total pago at√© ao momento:</strong> {{ total_pago|floatformat:2 }} ‚Ç¨</p>

        {% if historico %}
            {% for p in historico %}
                <div class="card history">
                    <strong>M√™s:</strong> {{ p.mes_referencia }}<br>
                    <strong>Data limite:</strong> {{ p.data_limite|date:"d/m/Y" }}<br>
                    <strong>Status:</strong> {{ p.get_status_display }} ‚úÖ<br>
                    <strong>Valor:</strong> {{ p.valor|floatformat:2 }} ‚Ç¨
                </div>
            {% endfor %}
        {% else %}
            <p class="text-center">Ainda n√£o existem pagamentos no hist√≥rico.</p>
        {% endif %}
    </div>

    <!-- CANCELAR / REATIVAR -->
    <div class="section text-center">
        {% if cancel_effective_from %}
            <p><em>A tua subscri√ß√£o j√° tem um cancelamento agendado.</em></p>
            <form action="{% url 'reativar_subscricao' %}" method="post">
                {% csrf_token %}
                <button type="submit" class="reactivate-btn">Reativar Subscri√ß√£o</button>
            </form>
        {% else %}
            <h3>‚ùå Cancelar Subscri√ß√£o</h3>
            <p>Tens at√© ao <strong>dia 15</strong> do m√™s anterior para pedir para cancelar a tua subscri√ß√£o</p>
            <form action="{% url 'cancelar_subscricao' %}" method="post">
                {% csrf_token %}
                <button type="submit" class="cancel-btn">Cancelar Subscri√ß√£o</button>
            </form>
        {% endif %}
    </div>

    <div class="text-center">
        <a href="{% url 'aluno_dashboard' %}" class="btn-back">Voltar √† p√°gina inicial</a>
    </div>
</div>
{% endblock %}
